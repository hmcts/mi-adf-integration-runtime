name: HMCTS Management Information ADF Self Hosted Integration Runtime Image
trigger:
  - master

pool:
  vmImage: 'windows-latest'

variables:
  projectName: 'mi'
  applicationName: 'adf-integration-runtime'
  azureSubscriptionEndpoint: 'DTS-SHAREDSERVICES-PROD'
  azureContainerRegistry: 'sdshmctspublic.azurecr.io'
  ${{ if eq(variables['Build.SourceBranchName'], 'master') }}: 
    deployTarget: prod
  ${{ if not(eq(variables['Build.SourceBranchName'], 'master')) }}: 
    deployTarget: dev

parameters:
  - name: pushPowershell
    displayName: Push Powershell Image
    type: boolean
    default: false

stages:
  - stage: BuildAndPush
    jobs:
      - job: BuildAndPush
        steps:
          - bash: |
              repo_sha=$(git rev-parse --verify HEAD)
              docker_image_tag_sha=${repo_sha:0:7}
              echo "##vso[task.setvariable variable=DOCKER_TAG;isOutput=true]${docker_image_tag_sha}"
            displayName: 'Get Docker Tag'
            name: 'getDockerTag'
          - task: Docker@1
            displayName: 'Docker Login'
            inputs:
              azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
              azureContainerRegistry: $(azureContainerRegistry)
              command: login
          # If push powershell image to private acr for neuvector
          - ${{ if eq(parameters.pushPowershell, true) }}:
            - task: Docker@1
              displayName: 'Build Powershell Dependency Docker Image'
              inputs:
                imageName: '$(azureContainerRegistry)/$(projectName)/powershell:latest'
                command: build
                Dockerfile: ./powershell/Dockerfile
            - task: Docker@1
              displayName: 'Push Powershell Dependency Docker Image'
              inputs:
                azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
                azureContainerRegistry: $(azureContainerRegistry)
                command: push
                imageName: '$(azureContainerRegistry)/$(projectName)/powershell:latest'
          # End If
          - task: Docker@1
            displayName: 'Build Docker Image'
            inputs:
              imageName: '$(azureContainerRegistry)/$(projectName)/$(applicationName):$(deployTarget)-$(getDockerTag.DOCKER_TAG)'
              command: build
              Dockerfile: ./Dockerfile
          - task: Docker@1
            condition: not(startsWith(variables['Build.SourceBranch'], 'refs/pull/'))
            displayName: 'Push Docker Image'
            inputs:
              azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
              azureContainerRegistry: $(azureContainerRegistry)
              command: push
              imageName: '$(projectName)/$(applicationName):$(deployTarget)-$(getDockerTag.DOCKER_TAG)'
          - task: Docker@1
            displayName: 'Docker Logout'
            inputs:
              command: logout